name: Build macOS CLI

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Sync dependencies
        working-directory: ibf
        run: uv sync --frozen

      - name: Install PyInstaller
        working-directory: ibf
        run: .venv/bin/python -m pip install --upgrade pip pyinstaller

      - name: Build standalone binary
        working-directory: ibf
        env:
          PYTHONPATH: src
        run: |
          .venv/bin/pyinstaller \
            src/ibf/__main__.py \
            --name "IBF" \
            --onefile \
            --clean \
            --collect-all ibf \
            --collect-all folium \
            --collect-all branca \
            --collect-all staticmap \
            --add-data "assets/terrain/global_terrain_ultra_compressed.pkl.gz:ibf/assets/terrain"

      - name: Package distributable
        working-directory: ibf
        run: |
          mkdir -p dist/IBF_macOS
          cp dist/IBF dist/IBF_macOS/IBF
          cp examples/sample-config.json dist/IBF_macOS/sample-config.json
          cat <<'EOF' > dist/IBF_macOS/README-macOS.txt
          IBF macOS build
          ----------------

          Usage
          1. Copy your .env beside this binary (same format as the repo's .env.example).
          2. Update sample-config.json or supply your own config path.
          3. From Terminal run:
             ./IBF run --config /full/path/to/config.json

          Notes
          - The binary is console-based, so run it from Terminal.
          - Selenium-powered map screenshots still require Chrome + chromedriver on your Mac.
          - Output folders are created relative to the working directory when you invoke the command.
          EOF
          cd dist
          zip -r IBF_macOS.zip IBF_macOS

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: IBF-macOS
          path: ibf/dist/IBF_macOS.zip

      - name: Get version
        id: version
        run: echo "version=$(date +'%Y.%m.%d.%H%M')" >> "$GITHUB_OUTPUT"

      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          name: IBF macOS v${{ steps.version.outputs.version }}
          tag_name: macos-v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: ibf/dist/IBF_macOS.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
