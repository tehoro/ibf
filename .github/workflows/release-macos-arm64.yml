name: Build macOS releases

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-macos-arm64:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller

      - name: Build binary
        run: |
          python -m PyInstaller --clean --onefile --name ibf \
            --add-data "assets/terrain/global_terrain_ultra_compressed.pkl.gz:assets/terrain" \
            packaging/ibf_entrypoint.py

      - name: Import signing certificate
        id: codesign
        env:
          MACOS_SIGNING_CERT_BASE64: ${{ secrets.MACOS_SIGNING_CERT_BASE64 }}
          MACOS_SIGNING_CERT_PASSWORD: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          if [ -z "$MACOS_SIGNING_CERT_BASE64" ] || [ -z "$MACOS_SIGNING_CERT_PASSWORD" ] || [ -z "$MACOS_SIGNING_IDENTITY" ]; then
            echo "Signing secrets missing; skipping codesign."
            echo "signed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          set -euo pipefail
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"
          CERT_PATH="$RUNNER_TEMP/ibf_signing.p12"
          echo "$MACOS_SIGNING_CERT_BASE64" | base64 -D > "$CERT_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import "$CERT_PATH" -k build.keychain -P "$MACOS_SIGNING_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          codesign --force --options runtime --entitlements packaging/entitlements.plist --sign "$MACOS_SIGNING_IDENTITY" dist/ibf
          codesign --verify --strict --verbose=2 dist/ibf
          echo "signed=true" >> "$GITHUB_OUTPUT"

      - name: Notarize binary
        if: ${{ steps.codesign.outputs.signed == 'true' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_TEAM_ID" ] || [ -z "$APPLE_APP_PASSWORD" ]; then
            echo "Notarization secrets missing; skipping notarization."
            exit 0
          fi
          set -euo pipefail
          ditto -c -k --sequesterRsrc --keepParent dist/ibf "$RUNNER_TEMP/ibf-notarize.zip"
          xcrun notarytool submit "$RUNNER_TEMP/ibf-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          echo "Notarization accepted; skipping stapling for standalone CLI binary."
          spctl -a -vv --type execute dist/ibf || true

      - name: Package release
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/ibf ibf-macos-arm64.zip
          shasum -a 256 ibf-macos-arm64.zip > ibf-macos-arm64.zip.sha256

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ibf-macos-arm64.zip
            ibf-macos-arm64.zip.sha256

  build-macos-x86_64:
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller

      - name: Build binary
        run: |
          python -m PyInstaller --clean --onefile --name ibf \
            --add-data "assets/terrain/global_terrain_ultra_compressed.pkl.gz:assets/terrain" \
            packaging/ibf_entrypoint.py

      - name: Import signing certificate
        id: codesign
        env:
          MACOS_SIGNING_CERT_BASE64: ${{ secrets.MACOS_SIGNING_CERT_BASE64 }}
          MACOS_SIGNING_CERT_PASSWORD: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          if [ -z "$MACOS_SIGNING_CERT_BASE64" ] || [ -z "$MACOS_SIGNING_CERT_PASSWORD" ] || [ -z "$MACOS_SIGNING_IDENTITY" ]; then
            echo "Signing secrets missing; skipping codesign."
            echo "signed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          set -euo pipefail
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"
          CERT_PATH="$RUNNER_TEMP/ibf_signing.p12"
          echo "$MACOS_SIGNING_CERT_BASE64" | base64 -D > "$CERT_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import "$CERT_PATH" -k build.keychain -P "$MACOS_SIGNING_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          codesign --force --options runtime --entitlements packaging/entitlements.plist --sign "$MACOS_SIGNING_IDENTITY" dist/ibf
          codesign --verify --strict --verbose=2 dist/ibf
          echo "signed=true" >> "$GITHUB_OUTPUT"

      - name: Notarize binary
        if: ${{ steps.codesign.outputs.signed == 'true' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_TEAM_ID" ] || [ -z "$APPLE_APP_PASSWORD" ]; then
            echo "Notarization secrets missing; skipping notarization."
            exit 0
          fi
          set -euo pipefail
          ditto -c -k --sequesterRsrc --keepParent dist/ibf "$RUNNER_TEMP/ibf-notarize.zip"
          xcrun notarytool submit "$RUNNER_TEMP/ibf-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          echo "Notarization accepted; skipping stapling for standalone CLI binary."
          spctl -a -vv --type execute dist/ibf || true

      - name: Package release
        run: |
          ditto -c -k --sequesterRsrc --keepParent dist/ibf ibf-macos-x86_64.zip
          shasum -a 256 ibf-macos-x86_64.zip > ibf-macos-x86_64.zip.sha256

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ibf-macos-x86_64.zip
            ibf-macos-x86_64.zip.sha256

  build-windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pyinstaller

      - name: Build binary
        run: |
          python -m PyInstaller --clean --onefile --name ibf ^
            --add-data "assets/terrain/global_terrain_ultra_compressed.pkl.gz;assets/terrain" ^
            packaging/ibf_entrypoint.py

      - name: Smoke test
        run: .\dist\ibf.exe --version

      - name: Package release
        run: |
          Compress-Archive -Path dist\ibf.exe -DestinationPath ibf-windows-x86_64.zip
          $hash = (Get-FileHash ibf-windows-x86_64.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  ibf-windows-x86_64.zip" | Out-File -Encoding ascii ibf-windows-x86_64.zip.sha256

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ibf-windows-x86_64.zip
            ibf-windows-x86_64.zip.sha256
